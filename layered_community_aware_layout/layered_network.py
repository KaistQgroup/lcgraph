import networkx as nx
import numpy as np

from models.network_module import LayeredLawNetwork
from layered_community_aware_layout.layered_tabu_search import LayeredTabuSearch
from models.frame_module import Frame

import parmap
from itertools import chain

class LayeredLayout:

    def __init__(self, law_graph, extent=None):
        self.network = LayeredLawNetwork(law_graph)
    
    def layered_community_layout(self):
        self.assign_initial_positions()
        self.optimize_positions()
        self.assign_node_positions()      

    def assign_initial_positions(self):
        for level in range(1, self.network.max_level + 1):
            community_set_list = self.network.levels[level]
            for comm_set in community_set_list:
                initial_positions = {}

                grids_copy = comm_set.get_spring_frame().get_grids_array() #comm_set.get_frame().get_grids_array()
                dis_grids_copy = comm_set.get_frame().get_disconnected_grids_array()

                for key, community in comm_set.get_communities_dict().items():
                    if level == 1 and community.get_is_disconnected():
                        position = dis_grids_copy.pop(0)
                    else:
                        position = grids_copy.pop(0)
                    
                    community.set_central_position(position)
                    initial_positions[key] = position

                comm_set.set_community_positions(initial_positions)
                
    def optimize_positions(self):
        # Flatten all lists into a single list
        all_comm_sets = list(chain.from_iterable(self.network.levels.values()))

        tabu_search = LayeredTabuSearch(self.network)
        tabu_search.optimize_parmap(all_comm_sets)

    def assign_node_positions(self):
        calculate_node_positions = False
        rescaled = False
        positions = {}
        for level in range(1, self.network.max_level + 1):
            community_set_list = self.network.levels[level]
            for comm_set in community_set_list:
                if level == self.network.max_level:
                    calculate_node_positions = True
                if not level == 1:
                    rescaled = True
                positions.update(comm_set.set_node_positions(calculate_node_positions, rescaled))
        return positions
    
        
    
# if __name__ == '__main__':
#     law_db = LawDB()
#     law_graph = law_db.create_networkx_graph()

#     layout = LayeredLayout(law_graph)
#     initial_positions = {'0_0_0': {'1_0_0': (0.0, 0.0), '1_0_1': (1953.0, 0.0), '1_0_2': (3906.0, 0.0), '1_0_3': (5859.0, 0.0), '1_0_5': (976.5, 1691.3476135910087), '1_0_7': (2929.5, 1691.3476135910087), '1_0_13': (4882.5, 1691.3476135910087), '1_0_16': (6835.5, 1691.3476135910087), '1_0_18': (0.0, 3382.6952271820173), '1_0_4': (1953.0, 3382.6952271820173), '1_0_6': (3906.0, 3382.6952271820173), '1_0_8': (5859.0, 3382.6952271820173), '1_0_9': (976.5, 5074.042840773026), '1_0_10': (2929.5, 5074.042840773026), '1_0_11': (4882.5, 5074.042840773026), '1_0_12': (6835.5, 5074.042840773026), '1_0_14': (0.0, 6765.390454364035), '1_0_15': (1953.0, 6765.390454364035), '1_0_17': (3906.0, 6765.390454364035)}, '1_0_0': {'2_0_0': (0.0, 0.0), '2_0_1': (1570.0, 0.0), '2_0_2': (3140.0, 0.0), '2_0_3': (785.0, 1359.6598839415685), '2_0_4': (2355.0, 1359.6598839415685), '2_0_5': (3925.0, 1359.6598839415685), '2_0_6': (0.0, 2719.319767883137), '2_0_7': (1570.0, 2719.319767883137), '2_0_8': (3140.0, 2719.319767883137), '2_0_9': (785.0, 4078.979651824706), '2_0_10': (2355.0, 4078.979651824706)}, '1_0_1': {'2_1_0': (0.0, 0.0), '2_1_1': (1482.0, 0.0), '2_1_2': (2964.0, 0.0), '2_1_3': (741.0, 1283.449648408538), '2_1_4': (2223.0, 1283.449648408538), '2_1_5': (3705.0, 1283.449648408538), '2_1_6': (1852.5, 2566.899296817076)}, '1_0_2': {'2_2_0': (0.0, 0.0), '2_2_1': (1505.0, 0.0), '2_2_2': (3010.0, 0.0), '2_2_3': (752.5, 1303.36823269558), '2_2_4': (2257.5, 1303.36823269558), '2_2_5': (3762.5, 1303.36823269558), '2_2_6': (0.0, 2606.73646539116), '2_2_7': (1505.0, 2606.73646539116), '2_2_8': (3010.0, 2606.73646539116), '2_2_9': (752.5, 3910.1046980867404), '2_2_10': (2257.5, 3910.1046980867404)}, '1_0_3': {'2_3_0': (0.0, 0.0), '2_3_1': (1551.0, 0.0), '2_3_2': (775.5, 1343.2054012696642), '2_3_3': (2326.5, 1343.2054012696642), '2_3_4': (0.0, 2686.4108025393284), '2_3_5': (1551.0, 2686.4108025393284), '2_3_6': (775.5, 4029.616203808993), '2_3_7': (2326.5, 4029.616203808993)}, '1_0_5': {'2_5_0': (0.0, 0.0), '2_5_1': (1689.0, 0.0), '2_5_2': (3378.0, 0.0), '2_5_3': (844.5, 1462.7169069919169), '2_5_4': (2533.5, 1462.7169069919169), '2_5_5': (4222.5, 1462.7169069919169), '2_5_6': (0.0, 2925.4338139838337), '2_5_7': (1689.0, 2925.4338139838337), '2_5_8': (3378.0, 2925.4338139838337), '2_5_9': (844.5, 4388.15072097575), '2_5_10': (2533.5, 4388.15072097575), '2_5_11': (4222.5, 4388.15072097575)}, '1_0_7': {'2_7_0': (0.0, 0.0), '2_7_1': (1397.0, 0.0), '2_7_2': (698.5, 1209.8374890868606)}, '1_0_13': {'2_13_0': (0.0, 0.0), '2_13_1': (1559.0, 0.0), '2_13_2': (3118.0, 0.0), '2_13_3': (4677.0, 0.0), '2_13_4': (779.5, 1350.1336044999398), '2_13_5': (2338.5, 1350.1336044999398), '2_13_6': (3897.5, 1350.1336044999398), '2_13_7': (5456.5, 1350.1336044999398), '2_13_8': (0.0, 2700.2672089998796), '2_13_9': (1559.0, 2700.2672089998796), '2_13_10': (3118.0, 2700.2672089998796), '2_13_11': (4677.0, 2700.2672089998796), '2_13_12': (779.5, 4050.4008134998194), '2_13_13': (2338.5, 4050.4008134998194), '2_13_14': (3897.5, 4050.4008134998194), '2_13_15': (5456.5, 4050.4008134998194), '2_13_16': (0.0, 5400.534417999759), '2_13_17': (1559.0, 5400.534417999759), '2_13_18': (3118.0, 5400.534417999759), '2_13_19': (4677.0, 5400.534417999759), '2_13_20': (779.5, 6750.668022499699), '2_13_21': (2338.5, 6750.668022499699), '2_13_22': (3897.5, 6750.668022499699), '2_13_23': (5456.5, 6750.668022499699)}, '1_0_16': {'2_16_0': (0.0, 0.0), '2_16_1': (1583.0, 0.0), '2_16_2': (3166.0, 0.0), '2_16_3': (791.5, 1370.9182141907663), '2_16_4': (2374.5, 1370.9182141907663), '2_16_5': (3957.5, 1370.9182141907663), '2_16_6': (0.0, 2741.8364283815326), '2_16_7': (1583.0, 2741.8364283815326), '2_16_8': (3166.0, 2741.8364283815326), '2_16_9': (791.5, 4112.7546425722985), '2_16_10': (2374.5, 4112.7546425722985)}, '1_0_18': {'2_18_0': (0.0, 0.0), '2_18_1': (1674.0, 0.0), '2_18_2': (3348.0, 0.0), '2_18_3': (837.0, 1449.7265259351502), '2_18_4': (2511.0, 1449.7265259351502), '2_18_5': (4185.0, 1449.7265259351502), '2_18_6': (2092.5, 2899.4530518703004)}, '1_0_4': {'2_4_0': (687.0, 594.9594523999093)}, '1_0_6': {'2_6_0': (687.0, 594.9594523999093)}, '1_0_8': {'2_8_0': (687.0, 594.9594523999093)}, '1_0_9': {'2_9_0': (687.0, 594.9594523999093)}, '1_0_10': {'2_10_0': (687.0, 594.9594523999093)}, '1_0_11': {'2_11_0': (687.0, 594.9594523999093)}, '1_0_12': {'2_12_0': (687.0, 594.9594523999093)}, '1_0_14': {'2_14_0': (687.0, 594.9594523999093)}, '1_0_15': {'2_15_0': (687.0, 594.9594523999093)}, '1_0_17': {'2_17_0': (687.0, 594.9594523999093)}}
#     optimized_positions = layout.optimize_positions(initial_positions)









